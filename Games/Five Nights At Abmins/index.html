<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5 Nights at Abmin's - Exploration Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ======================= RESET & BASE ======================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Press Start 2P', monospace;
            cursor: default;
        }

        .hidden { display: none !important; }

        .static-noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0.05;
            pointer-events: none;
            z-index: 1000;
        }

        /* ======================= MAIN MENU ======================= */
        #main-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a0505 0%, #000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .menu-content { text-align: center; animation: flicker 4s infinite; }
        @keyframes flicker {
            0%, 90%, 100% { opacity: 1; }
            92%, 95% { opacity: 0.8; }
            94% { opacity: 0.5; }
        }

        .menu-title {
            font-family: 'Creepster', cursive;
            font-size: 80px;
            color: #ff2222;
            text-shadow: 0 0 20px #ff0000;
            margin-bottom: 50px;
        }

        .menu-title span { display: block; font-size: 100px; color: #ffcc00; }

        .menu-btns { display: flex; flex-direction: column; gap: 20px; align-items: center; }

        .m-btn {
            background: transparent;
            color: #777;
            border: 2px solid #333;
            padding: 20px 60px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Press Start 2P', monospace;
        }

        .m-btn:hover { color: #fff; border-color: #ff2222; box-shadow: 0 0 20px rgba(255, 34, 34, 0.4); }

        /* ======================= GAME UI ======================= */
        #game-view { position: relative; width: 100vw; height: 100vh; }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #clock {
            position: absolute;
            top: 30px;
            right: 40px;
            color: #fff;
            font-size: 32px;
            text-shadow: 2px 2px #000;
        }

        #power-hud {
            position: absolute;
            bottom: 30px;
            left: 30px;
            color: #0f0;
            font-size: 16px;
            text-shadow: 0 0 10px #0f0;
        }

        #usage-meter { display: flex; gap: 8px; margin-top: 10px; }
        .u-bar { width: 15px; height: 25px; background: #030; border: 1px solid #060; }
        .u-bar.active { background: #0f0; box-shadow: 0 0 10px #0f0; }

        /* ======================= HOTBAR ======================= */
        #hotbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid #333;
            pointer-events: all;
            z-index: 500;
        }

        .hotbar-slot {
            width: 60px;
            height: 60px;
            border: 2px solid #555;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #444;
            font-size: 10px;
            position: relative;
        }

        .hotbar-slot.active { border-color: #0f0; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); color: #fff; }
        .slot-key { position: absolute; top: 2px; left: 4px; font-size: 8px; color: #666; }

        /* ======================= MONITOR ======================= */
        #monitor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 150;
            pointer-events: all;
        }

        #monitor-overlay.active { display: block; }
        #cam-info { position: absolute; top: 50px; left: 50px; color: #fff; font-size: 20px; }

        #map-container {
            position: absolute;
            bottom: 120px;
            right: 50px;
            width: 380px;
            height: 380px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #444;
            padding: 10px;
        }

        .map-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        .cam-node {
            position: absolute;
            z-index: 10;
            background: #000;
            color: #888;
            border: 1px solid #444;
            font-size: 9px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
        }

        .cam-node.active { background: #0a4; color: #fff; border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        #office-node {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #000;
            border: 3px solid #fff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 9px;
        }

        #office-node::after { content: "YOU"; display: block; margin-top: 5px; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.3; } }

        #close-monitor {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 80px;
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            border: 3px solid #777;
            border-bottom: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            z-index: 200;
        }

        #close-monitor:hover { background: #555; border-color: #fff; }

        /* ======================= OVERLAYS ======================= */
        #jumpscare-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        #jumpscare-overlay img { height: 90%; animation: sc-shake 0.05s infinite; }

        @keyframes sc-shake {
            0% { transform: translate(5px, 5px) rotate(0.5deg); }
            50% { transform: translate(-5px, -5px) rotate(-0.5deg); }
            100% { transform: translate(0, 0); }
        }

        #win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3001;
            font-size: 100px;
        }

        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5000;
            pointer-events: none;
            display: none;
        }

        #crosshair::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 2px; height: 2px;
            background: white;
            transform: translate(-50%, -50%);
        }

        body.playing #crosshair { display: block; }
        body.monitor-active #crosshair { display: none; }

        canvas { display: block; outline: none; }
    </style>
</head>
<body class="menu-active">

    <div class="static-noise"></div>
    <div id="crosshair"></div>

    <!-- MAIN MENU -->
    <div id="main-menu">
        <div class="menu-content">
            <h1 class="menu-title">Five Nights<br><span>at Abmin's</span></h1>
            <div class="menu-btns">
                <button class="m-btn" id="new-game-btn">NEW GAME</button>
                <button class="m-btn" id="continue-btn">CONTINUE</button>
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view" class="hidden">
        <div id="ui-layer">
            <div id="clock">12 AM</div>
            <div id="power-hud">
                <div>POWER LEFT: <span id="power-val">100</span>%</div>
                <div id="usage-meter">
                    <div class="u-bar"></div>
                    <div class="u-bar"></div>
                    <div class="u-bar"></div>
                    <div class="u-bar"></div>
                    <div class="u-bar"></div>
                </div>
            </div>

            <div id="hotbar">
                <div class="hotbar-slot active" data-slot="1">
                    <span class="slot-key">1</span>
                    FLASHLIGHT
                </div>
                <div class="hotbar-slot" data-slot="2">
                    <span class="slot-key">2</span>
                    EMPTY
                </div>
                <div class="hotbar-slot" data-slot="3">
                    <span class="slot-key">3</span>
                    EMPTY
                </div>
            </div>
        </div>

        <!-- CAMERA OVERLAY -->
        <div id="monitor-overlay">
            <div id="cam-info">CAM 1A - SHOW STAGE</div>
            
            <div id="map-container">
                <svg class="map-bg" viewBox="0 0 380 380">
                    <path d="M 190 20 L 190 140" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" /> 
                    <path d="M 190 80 L 80 80" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 190 80 L 300 80" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 190 140 L 100 140" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 190 140 L 280 140" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 100 140 L 100 300" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 100 140 L 50 140" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 280 140 L 280 300" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 100 300 L 160 300" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                    <path d="M 280 300 L 220 300" stroke="#fff" stroke-width="2" fill="none" opacity="0.4" />
                </svg>
                
                <div class="cam-node active" data-cam="1A" data-label="SHOW STAGE" style="top:10px; left:40%;">1A</div>
                <div class="cam-node" data-cam="1B" data-label="DINING AREA" style="top:70px; left:42%;">1B</div>
                <div class="cam-node" data-cam="1C" data-label="PIRATE COVE" style="top:70px; left:10%;">1C</div>
                
                <div class="cam-node" data-cam="2A" data-label="W. HALL NORTH" style="top:130px; left:20%;">2A</div>
                <div class="cam-node" data-cam="2B" data-label="W. HALL SOUTH" style="top:250px; left:20%;">2B</div>
                
                <div class="cam-node" data-cam="4A" data-label="E. HALL NORTH" style="top:130px; left:65%;">4A</div>
                <div class="cam-node" data-cam="4B" data-label="E. HALL SOUTH" style="top:250px; left:65%;">4B</div>
                
                <div class="cam-node" data-cam="3" data-label="SUPPLY CLOSET" style="top:130px; left:2%;">3</div>
                <div class="cam-node" data-cam="6" data-label="KITCHEN" style="top:70px; left:75%;">6</div>

                <div id="office-node">OFFICE</div>
            </div>

            <div id="close-monitor">CLOSE MONITOR</div>
        </div>

        <div id="jumpscare-overlay">
            <img id="js-img" src="" alt="">
        </div>

        <div id="win-overlay">6 AM</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ======================= CONFIG =======================
        const CONFIG = {
            HOUR_LEN: 45, 
            MOVE_SPEED: 4.5,
            COLLISION_RADIUS: 0.4,
            images: {
                Devil: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQevmPBcXlRBwNwZS5Yd5fQEx2lwQZm4VaznQ&s',
                Freak: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv-Y-8unCnufjKBV5qT7QL_VxyGST0PPRYfw&s',
                Absolute: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRcaDc6IF51Cwx-1rYJ0XCu8LkpJGmRWZwyPA&s'
            }
        };

        const CAM_VIEWS = {
            '1A': { pos: [9, 2.5, 4.5], rot: [-0.4, 0, 0] },
            '1B': { pos: [14.5, 2.5, 5], rot: [-0.4, 2.5, 0] },
            '1C': { pos: [6, 2.3, 7.5], rot: [-0.4, Math.PI / 2, 0] },
            '2A': { pos: [5.5, 2.2, 11.5], rot: [-0.4, Math.PI, 0] },
            '2B': { pos: [5.5, 2.2, 16], rot: [-0.4, Math.PI, 0] },
            '3': { pos: [2.5, 2.0, 13], rot: [-0.3, Math.PI, 0] },
            '4A': { pos: [12.5, 2.2, 11.5], rot: [-0.4, Math.PI, 0] },
            '4B': { pos: [12.5, 2.2, 16], rot: [-0.4, Math.PI, 0] },
            '6': { pos: [17, 2.4, 5], rot: [-0.4, Math.PI, 0] }
        };

        const BOT_SPOTS = {
            '1A': [9, 0, 1.5],
            '1B': [9.5, 0, 7.5],
            '1C': [2.5, 0, 7.5],
            '2A': [5.5, 0, 14.5],
            '2B': [6.8, 0, 18.2],
            '3': [2.5, 0, 14.5],
            '4A': [12.5, 0, 14.5],
            '4B': [11.2, 0, 18.2],
            '6': [17, 0, 6.5]
        };

        const MAP_LAYOUT = [
            "WWWWWWWWWWWWWWWWWWWW",
            "WGGGWSSSSSSSSWWWWWWW",
            "WGGGWSSSSSSSSWWWWWWW",
            "WGGGWSSSSSSSSWWWWWWW",
            "WGGGWGGGGGGGGGGGGGGW",
            "WGGGGGGGGGGGGGGGGGGW",
            "WPPPGGGGGGGGGGGGGGGW",
            "WPPPGGGGGGGGGWWWWWWW",
            "WPPPGGGGGGGGGGGGGGGW",
            "WGGGGGGGGGGGGGGGGGGW",
            "WGGGGGGGGGGGGGGGGGGW",
            "WWWWWGGWWWWWWGGGGWWW",
            "WGGWWGGWWWWWWGGGGWWW",
            "WGGGGGGWWWWWWGGGGWWW",
            "WGGWWGGWWWWWWGGGGWWW",
            "WWWWWGGWWWWWWGGGGWWW",
            "WWWWWGGWWWWWWGGGGWWW",
            "WWWWWGGWDDDWWGGGGWWW",
            "WWWWWGGOGGOGGGGGGGGW",
            "WWWWWGGWGGGWGGGGWWWW",
            "WWWWWWWGGGGWWWWWWWWW"
        ];

        // ======================= STATE =======================
        const State = {
            power: 100, usage: 0, hour: 0, time: 0,
            leftDoor: false, rightDoor: false,
            leftLight: false, rightLight: false,
            monitor: false, currentCam: '1A',
            isLocked: false, gameOver: false,
            pitch: 0, yaw: 0,
            keys: {},
            flashlightOn: false,
            currentSlot: 1
        };

        // ======================= AUDIO =======================
        const Sound = {
            initDone: false, audioCtx: null, started: false,
            tracks: {
                static: new Audio('https://github.com/SimonKlamcah/asdasdas/raw/refs/heads/main/staticnoise.mp3'),
                jumpscare: new Audio('https://github.com/SimonKlamcah/asdasdas/raw/refs/heads/main/jumpscare.mp3'),
                win: new Audio('https://github.com/SimonKlamcah/asdasdas/raw/refs/heads/main/6am%20bells%20ringing.mp3')
            },
            init() {
                if(this.initDone) return;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.tracks.static.loop = true;
                this.tracks.static.volume = 0.05;
                this.initDone = true;
            },
            play(id) {
                if(!this.initDone) return;
                this.tracks[id].currentTime = 0;
                this.tracks[id].play().catch(() => {});
            },
            click() {
                if(!this.audioCtx) return;
                const o = this.audioCtx.createOscillator();
                const g = this.audioCtx.createGain();
                o.connect(g); g.connect(this.audioCtx.destination);
                o.frequency.setValueAtTime(600, this.audioCtx.currentTime);
                g.gain.setValueAtTime(0.015, this.audioCtx.currentTime);
                o.start();
                g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.1);
                o.stop(this.audioCtx.currentTime + 0.1);
            }
        };

        // ======================= GAME ENGINE =======================
        const App = {
            scene: null, cam: null, monCam: null, renderer: null, clock: null, ray: null,
            interactables: [],
            doorL: null, doorR: null,
            hallLightL: null, hallLightR: null,
            maskL: null, maskR: null,
            flashlight: null,
            bots: {
                Devil: { m: null, spot: '1A', timer: 0, chasing: false },
                Freak: { m: null, spot: '1A', timer: 0, chasing: false },
                Absolute: { m: null, spot: '1B', timer: 0, chasing: false }
            },

            init() {
                this.setupScene();
                this.setupLights();
                this.setupOffice();
                this.setupMap();
                this.setupBots();
                this.bindEvents();
                this.updateUsage();
                this.animate();
            },

            setupScene() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x010101);

                this.cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.cam.position.set(9, 1.4, 19.2);
                this.cam.rotation.order = 'YXZ';

                this.monCam = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.monCam.rotation.order = 'YXZ';

                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('game-view').appendChild(this.renderer.domElement);

                this.clock = new THREE.Clock();
                this.ray = new THREE.Raycaster();

                // Flashlight Setup
                this.flashlight = new THREE.SpotLight(0xffffff, 0, 15, Math.PI / 6, 0.5, 1);
                this.cam.add(this.flashlight);
                this.flashlight.position.set(0.2, -0.2, 0);
                this.flashlight.target = new THREE.Object3D();
                this.cam.add(this.flashlight.target);
                this.flashlight.target.position.set(0, 0, -5);
                this.scene.add(this.cam);
            },

            setupLights() {
                this.scene.add(new THREE.AmbientLight(0x0a0a0a));
                const pLight = (x, y, z, c, i, d) => {
                    const l = new THREE.PointLight(c, i, d);
                    l.position.set(x, y, z);
                    this.scene.add(l);
                    return l;
                };
                pLight(9, 2.4, 4, 0xffffff, 0.4, 15);
                pLight(9, 2.4, 12, 0xffffff, 0.3, 15);
                this.officeLight = pLight(9, 1.8, 18.5, 0x44ffaa, 0.6, 7);

                this.hallLightL = pLight(6.5, 1.8, 18.5, 0xffffff, 0, 6);
                this.hallLightR = pLight(11.5, 1.8, 18.5, 0xffffff, 0, 6);
            },

            setupOffice() {
                const btnMat = (c) => new THREE.MeshStandardMaterial({ color: c });
                const box = (w, h, d) => new THREE.BoxGeometry(w, h, d);

                const doorGeo = box(0.1, 2.8, 1.1);
                const doorMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
                
                this.doorL = new THREE.Mesh(doorGeo, doorMat);
                this.doorL.position.set(7.45, 4.2, 18);
                this.scene.add(this.doorL);

                this.doorR = new THREE.Mesh(doorGeo, doorMat);
                this.doorR.position.set(10.55, 4.2, 18);
                this.scene.add(this.doorR);

                const panelGeo = new THREE.PlaneGeometry(1.2, 2.8);
                const panelMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                
                this.maskL = new THREE.Mesh(panelGeo, panelMat);
                this.maskL.position.set(7.48, 1.4, 18.2);
                this.maskL.rotation.y = Math.PI/2;
                this.scene.add(this.maskL);

                this.maskR = new THREE.Mesh(panelGeo, panelMat);
                this.maskR.position.set(10.52, 1.4, 18.2);
                this.maskR.rotation.y = -Math.PI/2;
                this.scene.add(this.maskR);

                const createBtn = (x, side, type, c) => {
                    const hitBox = new THREE.Mesh(box(0.2, 0.4, 0.3), btnMat(c));
                    hitBox.position.set(x, type === 'door' ? 1.4 : 1.1, 18.8);
                    hitBox.userData = { side, type };
                    this.interactables.push(hitBox);
                    this.scene.add(hitBox);
                };
                createBtn(7.51, 'left', 'door', 0x990000);
                createBtn(7.51, 'left', 'light', 0x444444);
                createBtn(10.49, 'right', 'door', 0x990000);
                createBtn(10.49, 'right', 'light', 0x444444);

                const compGroup = new THREE.Group();
                const monMesh = new THREE.Mesh(box(0.8, 0.6, 0.2), btnMat(0x111111));
                const scrMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.7, 0.5), new THREE.MeshBasicMaterial({ color: 0x001133 }));
                scrMesh.position.z = 0.101;
                compGroup.add(monMesh); compGroup.add(scrMesh);
                compGroup.position.set(9, 1.0, 18.2);
                compGroup.rotation.y = Math.PI;
                monMesh.userData = { type: 'monitor' };
                this.interactables.push(monMesh);
                this.scene.add(compGroup);
            },

            setupMap() {
                const wallMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a });
                const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
                const ceilMat = new THREE.MeshStandardMaterial({ color: 0x050505 });

                for(let z=0; z<MAP_LAYOUT.length; z++) {
                    for(let x=0; x<MAP_LAYOUT[z].length; x++) {
                        const char = MAP_LAYOUT[z][x];
                        if(char === 'W') {
                            const w = new THREE.Mesh(new THREE.BoxGeometry(1, 2.8, 1), wallMat);
                            w.position.set(x, 1.4, z);
                            this.scene.add(w);
                        } else {
                            const f = new THREE.Mesh(new THREE.PlaneGeometry(1,1), floorMat);
                            f.rotation.x = -Math.PI/2;
                            f.position.set(x, 0, z);
                            this.scene.add(f);
                            const c = new THREE.Mesh(new THREE.PlaneGeometry(1,1), ceilMat);
                            c.rotation.x = Math.PI/2;
                            c.position.set(x, 2.8, z);
                            this.scene.add(c);
                        }
                    }
                }
            },

            setupBots() {
                const loader = new THREE.TextureLoader();
                Object.keys(CONFIG.images).forEach(key => {
                    loader.load(CONFIG.images[key], (tex) => {
                        const mat = new THREE.SpriteMaterial({ map: tex });
                        const s = new THREE.Sprite(mat);
                        s.scale.set(1.5, 1.5, 1);
                        this.bots[key].m = s;
                        this.scene.add(s);
                        this.updateBotSpot(key);
                    });
                });
            },

            updateBotSpot(key) {
                const b = this.bots[key];
                if(!b.m || b.chasing) return;
                const pos = BOT_SPOTS[b.spot];
                b.m.position.set(pos[0], 0.75, pos[2]);
                
                let isVisible = false;
                if(State.monitor && State.currentCam === b.spot) isVisible = true;
                else if (b.spot === '2B' && State.leftLight) isVisible = true;
                else if (b.spot === '4B' && State.rightLight) isVisible = true;

                b.m.visible = isVisible;
            },

            bindEvents() {
                window.addEventListener('resize', () => {
                    const w = window.innerWidth;
                    const h = window.innerHeight;
                    this.renderer.setSize(w, h);
                    this.cam.aspect = w/h; this.cam.updateProjectionMatrix();
                    this.monCam.aspect = w/h; this.monCam.updateProjectionMatrix();
                });

                document.addEventListener('pointerlockchange', () => {
                    State.isLocked = document.pointerLockElement === this.renderer.domElement;
                    document.body.classList.toggle('playing', State.isLocked);
                });

                document.addEventListener('mousemove', (e) => {
                    if(State.isLocked && !State.monitor && !State.gameOver) {
                        State.yaw -= e.movementX * 0.003;
                        State.pitch -= e.movementY * 0.003;
                        State.pitch = Math.max(-1.4, Math.min(1.4, State.pitch));
                        this.cam.rotation.set(State.pitch, State.yaw, 0);
                    }
                });

                window.addEventListener('keydown', (e) => {
                    State.keys[e.key.toLowerCase()] = true;
                    if(e.key >= '1' && e.key <= '3') this.switchSlot(parseInt(e.key));
                    if(e.key.toLowerCase() === 'f' && State.currentSlot === 1) this.toggleFlashlight();
                });

                window.addEventListener('keyup', (e) => {
                    State.keys[e.key.toLowerCase()] = false;
                });

                this.renderer.domElement.addEventListener('click', () => {
                    if(State.monitor || State.gameOver) return;
                    if(!State.isLocked) {
                        this.renderer.domElement.requestPointerLock();
                        return;
                    }

                    this.ray.setFromCamera(new THREE.Vector2(0, 0), this.cam);
                    const hits = this.ray.intersectObjects(this.interactables);
                    if(hits.length > 0) {
                        const data = hits[0].object.userData;
                        if(data.type === 'door') {
                            if(data.side === 'left') State.leftDoor = !State.leftDoor;
                            else State.rightDoor = !State.rightDoor;
                            hits[0].object.material.color.set((data.side === 'left' ? State.leftDoor : State.rightDoor) ? 0x00ff00 : 0x990000);
                        } else if(data.type === 'light') {
                            if(data.side === 'left') State.leftLight = !State.leftLight;
                            else State.rightLight = !State.rightLight;
                            hits[0].object.material.color.set((data.side === 'left' ? State.leftLight : State.rightLight) ? 0xffff00 : 0x444444);
                        } else if(data.type === 'monitor') {
                            this.toggleMonitor();
                        }
                        this.updateUsage();
                        Sound.click();
                    }
                });

                document.getElementById('close-monitor').addEventListener('click', () => this.toggleMonitor());

                document.querySelectorAll('.cam-node').forEach(node => {
                    node.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.switchCam(node.dataset.cam, node.dataset.label);
                    });
                });
            },

            switchSlot(n) {
                State.currentSlot = n;
                document.querySelectorAll('.hotbar-slot').forEach(s => {
                    s.classList.toggle('active', parseInt(s.dataset.slot) === n);
                });
                Sound.click();
            },

            toggleFlashlight() {
                State.flashlightOn = !State.flashlightOn;
                this.flashlight.intensity = State.flashlightOn ? 2.5 : 0;
                this.updateUsage();
                Sound.click();
            },

            toggleMonitor() {
                if(State.gameOver) return;
                State.monitor = !State.monitor;
                document.getElementById('monitor-overlay').classList.toggle('active', State.monitor);
                document.body.classList.toggle('monitor-active', State.monitor);
                
                if(State.monitor) document.exitPointerLock();
                else this.renderer.domElement.requestPointerLock();
                
                this.updateUsage();
                Object.keys(this.bots).forEach(k => this.updateBotSpot(k));
                Sound.click();
            },

            switchCam(id, label) {
                State.currentCam = id;
                document.getElementById('cam-info').innerText = `CAM ${id} - ${label}`;
                document.querySelectorAll('.cam-node').forEach(n => n.classList.toggle('active', n.dataset.cam === id));
                const view = CAM_VIEWS[id];
                if(view) {
                    this.monCam.position.set(...view.pos);
                    this.monCam.rotation.set(...view.rot);
                }
                Object.keys(this.bots).forEach(k => this.updateBotSpot(k));
                Sound.click();
            },

            updateUsage() {
                let u = 0;
                if(State.leftDoor) u++;
                if(State.rightDoor) u++;
                if(State.leftLight) u++;
                if(State.rightLight) u++;
                if(State.monitor) u++;
                if(State.flashlightOn) u++;
                State.usage = Math.min(u, 5);

                const bars = document.querySelectorAll('.u-bar');
                bars.forEach((b, i) => b.classList.toggle('active', i < State.usage));
            },

            checkCollision(nx, nz) {
                const ix = Math.round(nx);
                const iz = Math.round(nz);
                if(iz < 0 || iz >= MAP_LAYOUT.length || ix < 0 || ix >= MAP_LAYOUT[0].length) return true;
                if(MAP_LAYOUT[iz][ix] === 'W') return true;
                
                // Door Collisions
                if(State.leftDoor && nx < 7.5 && nz > 17.5 && nz < 18.5) return true;
                if(State.rightDoor && nx > 10.5 && nz > 17.5 && nz < 18.5) return true;
                
                return false;
            },

            jumpscare(botKey) {
                if(State.gameOver) return;
                State.gameOver = true;
                State.monitor = false;
                document.getElementById('monitor-overlay').classList.remove('active');
                document.exitPointerLock();

                const img = document.getElementById('js-img');
                img.src = CONFIG.images[botKey];
                document.getElementById('jumpscare-overlay').style.display = 'flex';
                
                Sound.play('jumpscare');
                setTimeout(() => location.reload(), 3500);
            },

            animate() {
                requestAnimationFrame(() => this.animate());
                const dt = this.clock.getDelta();

                if(!State.gameOver && Sound.started) {
                    State.time += dt;
                    const h = Math.floor(State.time / CONFIG.HOUR_LEN);
                    if(h > State.hour) {
                        State.hour = h;
                        document.getElementById('clock').innerText = (State.hour === 0 ? 12 : State.hour) + " AM";
                        if(State.hour === 6) {
                            State.gameOver = true;
                            document.getElementById('win-overlay').style.display = 'flex';
                            Sound.play('win');
                        }
                    }

                    if (State.usage > 0) {
                        State.power -= (0.04 + State.usage * 0.11) * dt;
                    }
                    
                    const pDisplay = document.getElementById('power-val');
                    if(pDisplay) pDisplay.innerText = Math.max(0, Math.floor(State.power));
                    if(State.power <= 0) this.jumpscare('Absolute');

                    // WASD Movement
                    if(State.isLocked && !State.monitor) {
                        const dir = new THREE.Vector3();
                        if(State.keys['w']) dir.z -= 1;
                        if(State.keys['s']) dir.z += 1;
                        if(State.keys['a']) dir.x -= 1;
                        if(State.keys['d']) dir.x += 1;
                        
                        if(dir.length() > 0) {
                            dir.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), State.yaw);
                            const nx = this.cam.position.x + dir.x * CONFIG.MOVE_SPEED * dt;
                            const nz = this.cam.position.z + dir.z * CONFIG.MOVE_SPEED * dt;
                            
                            if(!this.checkCollision(nx, this.cam.position.z)) this.cam.position.x = nx;
                            if(!this.checkCollision(this.cam.position.x, nz)) this.cam.position.z = nz;
                        }
                    }

                    // AI & Chase Logic
                    Object.keys(this.bots).forEach(k => {
                        const b = this.bots[k];
                        if(b.chasing) {
                            // Move towards player
                            const dir = new THREE.Vector3().subVectors(this.cam.position, b.m.position).setY(0);
                            const dist = dir.length();
                            if(dist < 1.0) this.jumpscare(k);
                            else {
                                dir.normalize();
                                b.m.position.addScaledVector(dir, (CONFIG.MOVE_SPEED * 0.8) * dt);
                                b.m.visible = true; // Always visible while chasing
                            }
                        } else {
                            b.timer += dt;
                            if(b.timer > (k === 'Freak' ? 5 : 8)) {
                                b.timer = 0;
                                if(Math.random() < 0.45) {
                                    if(b.spot === '1A') b.spot = '1B';
                                    else if(b.spot === '1B') b.spot = (Math.random() > 0.5 ? '2A' : '4A');
                                    else if(b.spot === '2A') b.spot = (Math.random() > 0.6 ? '2B' : '3');
                                    else if(b.spot === '4A') b.spot = (Math.random() > 0.5 ? '4B' : '6');
                                    else if(b.spot === '3') b.spot = '2A';
                                    else if(b.spot === '6') b.spot = '4A';
                                    else if(b.spot === '2B') {
                                        if(!State.leftDoor && this.cam.position.z > 17) this.jumpscare(k);
                                        else b.spot = '1A';
                                    }
                                    else if(b.spot === '4B') {
                                        if(!State.rightDoor && this.cam.position.z > 17) this.jumpscare(k);
                                        else b.spot = '1A';
                                    }
                                    this.updateBotSpot(k);
                                }
                            }

                            // Trigger Chase if player is near and visible outside the office
                            const distToPlayer = b.m.position.distanceTo(this.cam.position);
                            const inHalls = (b.spot === '2A' || b.spot === '2B' || b.spot === '4A' || b.spot === '4B');
                            if(distToPlayer < 4 && inHalls && !State.monitor) {
                                b.chasing = true;
                            }
                        }
                    });
                }

                if(this.doorL) this.doorL.position.y += ((State.leftDoor ? 1.4 : 4.2) - this.doorL.position.y) * 0.15;
                if(this.doorR) this.doorR.position.y += ((State.rightDoor ? 1.4 : 4.2) - this.doorR.position.y) * 0.15;
                if(this.maskL) this.maskL.visible = !State.leftLight;
                if(this.maskR) this.maskR.visible = !State.rightLight;
                if(this.hallLightL) this.hallLightL.intensity = State.leftLight ? 2.5 : 0;
                if(this.hallLightR) this.hallLightR.intensity = State.rightLight ? 2.5 : 0;

                this.renderer.render(this.scene, State.monitor ? this.monCam : this.cam);
            }
        };

        const Main = {
            init() {
                const ng = document.getElementById('new-game-btn');
                const cn = document.getElementById('continue-btn');
                const start = () => {
                    Sound.init();
                    Sound.started = true;
                    Sound.play('static');
                    document.getElementById('main-menu').classList.add('hidden');
                    document.getElementById('game-view').classList.remove('hidden');
                    const de = document.documentElement;
                    if (de.requestFullscreen) de.requestFullscreen().catch(() => {});
                    App.init();
                    App.renderer.domElement.requestPointerLock();
                };
                ng.addEventListener('click', start);
                cn.addEventListener('click', start);
            }
        };

        window.onload = Main.init;
    </script>
</body>
</html>